datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/////////////////////////////////////////////////////////
/////////////////// PROCESSO PRODUÃ‡ÃƒO ///////////////////
/////////////////////////////////////////////////////////

model OrdemProducao {
  id                  String   @id
  numeroOP            String   @unique
  descricaoProduto    String
  quantidadeProduzida Int
  status              String
  criadoEm            DateTime @default(now())

  nCodOP BigInt?

  eventos        EventoOP[]
  produtosFinais ProdutoFinal[]
  subprodutos    Subproduto[]
}

model EventoOP {
  id            String   @id
  opId          String
  etapa         String
  tipo          String
  funcionarioId String
  criadoEm      DateTime @default(now())

  ordemProducao OrdemProducao @relation(fields: [opId], references: [id])
}

model ProdutoFinal {
  id             String   @id
  opId           String
  serie          String   @unique
  codProdutoOmie String?
  criadoEm       DateTime @default(now())

  ordemProducao   OrdemProducao    @relation(fields: [opId], references: [id])
  subprodutos     Subproduto[]
  consumosPeca    ConsumoPeca[]
  expedicoesSerie ExpedicaoSerie[]
}

model Subproduto {
  id                 String   @id
  opId               String?
  produtoFinalId     String?
  opNumeroSubproduto String
  etiquetaId         String   @unique
  funcionarioId      String
  quantidade         Int
  criadoEm           DateTime @default(now())

  ordemProducao OrdemProducao? @relation(fields: [opId], references: [id])
  produtoFinal  ProdutoFinal?  @relation(fields: [produtoFinalId], references: [id])
  consumosPeca  ConsumoPeca[]
}

model ConsumoPeca {
  id            String @id
  codigoPeca    String
  qrCode        String
  funcionarioId String

  produtoFinalId String?
  subprodutoId   String?

  inicioEm DateTime  @default(now())
  fimEm    DateTime?

  produtoFinal ProdutoFinal? @relation(fields: [produtoFinalId], references: [id])
  subproduto   Subproduto?   @relation(fields: [subprodutoId], references: [id])

  // ðŸ”’ BLINDAGEM REAL
  @@unique([qrCode, fimEm])
  @@index([codigoPeca])
  @@index([qrCode])
  @@index([produtoFinalId])
  @@index([subprodutoId])
}

/////////////////////////////////////////////////////////
////////////////// PROCESSO EXPEDIÃ‡ÃƒO ///////////////////
/////////////////////////////////////////////////////////

model PedidoVenda {
  id       String   @id
  numeroPV String   @unique
  cliente  String
  criadoEm DateTime @default(now())

  itens      PedidoVendaItem[]
  expedicoes Expedicao[]
}

model PedidoVendaItem {
  id             String @id
  pedidoVendaId  String
  codProdutoOmie String
  descricao      String
  quantidade     Int

  pedidoVenda PedidoVenda @relation(fields: [pedidoVendaId], references: [id])

  @@index([codProdutoOmie])
}

model Expedicao {
  id            String    @id
  numeroPedido  String // nÃºmero digitado / lido
  status        String
  funcionarioId String
  iniciadoEm    DateTime  @default(now())
  finalizadoEm  DateTime?

  eventos       EventoExpedicao[]
  series        ExpedicaoSerie[]
  fotosGerais   FotoExpedicaoGeral[]
  PedidoVenda   PedidoVenda?         @relation(fields: [pedidoVendaId], references: [id])
  pedidoVendaId String?
}

model EventoExpedicao {
  id            String   @id
  expedicaoId   String
  tipo          String // inicio | pausa | retorno | fim
  funcionarioId String
  criadoEm      DateTime @default(now())

  expedicao Expedicao @relation(fields: [expedicaoId], references: [id])
}

model ExpedicaoSerie {
  id          String @id
  expedicaoId String

  // ðŸ”‘ produto sempre identificado
  codProdutoOmie String

  // ðŸ”¹ sÃ³ existe se o produto tiver sÃ©rie
  produtoFinalId String?
  serie          String?

  criadoEm DateTime @default(now())

  expedicao    Expedicao       @relation(fields: [expedicaoId], references: [id])
  produtoFinal ProdutoFinal?   @relation(fields: [produtoFinalId], references: [id])
  fotos        FotoExpedicao[]

  // ðŸ”’ uma sÃ©rie sÃ³ pode existir uma vez no sistema (quando existir)
  @@unique([serie])
  @@index([codProdutoOmie])
  @@index([serie])
}

model FotoExpedicao {
  id               String   @id
  expedicaoSerieId String
  url              String
  criadoEm         DateTime @default(now())

  expedicaoSerie ExpedicaoSerie @relation(fields: [expedicaoSerieId], references: [id])

  @@index([expedicaoSerieId])
}

model FotoExpedicaoGeral {
  id          String   @id
  expedicaoId String
  url         String
  descricao   String? // ex: "caixa fechada", "lote de tags", "palete completo"
  criadoEm    DateTime @default(now())

  expedicao Expedicao @relation(fields: [expedicaoId], references: [id])

  @@index([expedicaoId])
}
