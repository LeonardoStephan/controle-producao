datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model OrdemProducao {
  id                  String   @id
  numeroOP            String   @unique
  descricaoProduto    String
  quantidadeProduzida Int
  status              String
  criadoEm            DateTime @default(now())

  eventos        EventoOP[]
  produtosFinais ProdutoFinal[]
}

model EventoOP {
  id            String   @id
  opId          String
  etapa         String
  tipo          String
  funcionarioId String
  criadoEm      DateTime @default(now())

  ordemProducao OrdemProducao @relation(fields: [opId], references: [id])
}

model ProdutoFinal {
  id            String   @id
  opId          String
  serie         String   @unique
  codProdutoOmie String?  // <---- NOVO CAMPO
  criadoEm      DateTime @default(now())

  ordemProducao OrdemProducao @relation(fields: [opId], references: [id])
  subprodutos   Subproduto[]
  consumosPeca  ConsumoPeca[]
}

model Subproduto {
  id                 String   @id
  produtoFinalId     String
  opNumeroSubproduto String
  etiquetaId         String   @unique
  funcionarioId      String
  quantidade         Int
  criadoEm           DateTime @default(now())

  produtoFinal ProdutoFinal @relation(fields: [produtoFinalId], references: [id])
  consumosPeca ConsumoPeca[]
}

model ConsumoPeca {
  id            String   @id
  codigoPeca    String   // ex: CF_MU904 (igual Omie)
  qrCode        String   // conteúdo bruto do QR
  funcionarioId String

  produtoFinalId String?
  subprodutoId   String?

  inicioEm DateTime @default(now())
  fimEm    DateTime?

  produtoFinal ProdutoFinal? @relation(fields: [produtoFinalId], references: [id])
  subproduto   Subproduto?   @relation(fields: [subprodutoId], references: [id])

  @@index([codigoPeca])
  @@index([qrCode])
  @@index([produtoFinalId])
  @@index([subprodutoId])

  // garante que um QR não seja reutilizado enquanto ativo
  @@unique([qrCode, fimEm])
}
