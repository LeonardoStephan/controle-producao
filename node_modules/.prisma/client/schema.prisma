datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/////////////////////////////////////////////////////////
/////////////////// PROCESSO PRODUÇÃO ///////////////////
/////////////////////////////////////////////////////////

model OrdemProducao {
  id                  String   @id
  numeroOP            String   @unique
  empresa             String
  descricaoProduto    String
  quantidadeProduzida Int
  status              String
  criadoEm            DateTime @default(now())
  nCodOP              BigInt?

  eventos        EventoOP[]
  produtosFinais ProdutoFinal[]
  subprodutos    Subproduto[]
  consumosPeca   ConsumoPeca[]
}

model EventoOP {
  id            String   @id
  opId          String
  etapa         String
  tipo          String
  funcionarioId String
  criadoEm      DateTime @default(now())

  ordemProducao OrdemProducao @relation(fields: [opId], references: [id])
}

model ProdutoFinal {
  id             String   @id
  opId           String
  serie          String   @unique
  codProdutoOmie String?
  criadoEm       DateTime @default(now())

  ordemProducao   OrdemProducao    @relation(fields: [opId], references: [id])
  subprodutos     Subproduto[]
  consumosPeca    ConsumoPeca[]
  expedicoesSerie ExpedicaoSerie[]
}

model Subproduto {
  id String @id

  // ✅ subproduto sempre pertence a uma OP
  opId String

  produtoFinalId     String?
  opNumeroSubproduto String
  etiquetaId         String   @unique
  funcionarioId      String
  quantidade         Int
  codigoSubproduto   String?
  criadoEm           DateTime @default(now())

  ordemProducao OrdemProducao @relation(fields: [opId], references: [id])
  produtoFinal  ProdutoFinal? @relation(fields: [produtoFinalId], references: [id])
  consumosPeca  ConsumoPeca[]

  @@index([opId])
  @@index([codigoSubproduto])
  @@unique([produtoFinalId, codigoSubproduto])
}

model ConsumoPeca {
  id            String @id
  codigoPeca    String
  qrCode        String
  funcionarioId String
  opId          String

  produtoFinalId String?
  subprodutoId   String?

  inicioEm DateTime  @default(now())
  fimEm    DateTime?

  ordemProducao OrdemProducao @relation(fields: [opId], references: [id])
  produtoFinal  ProdutoFinal? @relation(fields: [produtoFinalId], references: [id])
  subproduto    Subproduto?   @relation(fields: [subprodutoId], references: [id])

  @@unique([qrCode, fimEm])
  @@index([codigoPeca])
  @@index([qrCode])
  @@index([produtoFinalId])
  @@index([subprodutoId])
  @@index([opId])
}

/////////////////////////////////////////////////////////
////////////////// PROCESSO EXPEDIÇÃO ///////////////////
/////////////////////////////////////////////////////////

model Expedicao {
  id            String    @id
  numeroPedido  String
  empresa       String?
  status        String
  funcionarioId String
  iniciadoEm    DateTime  @default(now())
  finalizadoEm  DateTime?

  eventos     EventoExpedicao[]
  series      ExpedicaoSerie[]
  fotosGerais FotoExpedicaoGeral[]
}

model EventoExpedicao {
  id            String   @id
  expedicaoId   String
  tipo          String
  funcionarioId String
  criadoEm      DateTime @default(now())

  expedicao Expedicao @relation(fields: [expedicaoId], references: [id])
}

model ExpedicaoSerie {
  id          String @id
  expedicaoId String

  codProdutoOmie String

  produtoFinalId String?
  serie          String?

  criadoEm DateTime @default(now())

  expedicao    Expedicao       @relation(fields: [expedicaoId], references: [id])
  produtoFinal ProdutoFinal?   @relation(fields: [produtoFinalId], references: [id])
  fotos        FotoExpedicao[]

  @@unique([serie])
  @@index([codProdutoOmie])
  @@index([serie])
}

model FotoExpedicao {
  id               String   @id
  expedicaoSerieId String
  url              String
  criadoEm         DateTime @default(now())

  expedicaoSerie ExpedicaoSerie @relation(fields: [expedicaoSerieId], references: [id])

  @@index([expedicaoSerieId])
}

model FotoExpedicaoGeral {
  id          String   @id
  expedicaoId String
  url         String
  descricao   String?
  criadoEm    DateTime @default(now())

  expedicao Expedicao @relation(fields: [expedicaoId], references: [id])

  @@index([expedicaoId])
}
