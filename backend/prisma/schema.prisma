datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/////////////////////////////////////////////////////////
/////////////////// PROCESSO PRODUÃ‡ÃƒO ///////////////////
/////////////////////////////////////////////////////////

model OrdemProducao {
  id                  String   @id
  numeroOP            String   @unique
  empresa             String
  descricaoProduto    String
  quantidadeProduzida Int
  tipoOp              String   @default("produto_final")
  status              String
  version             Int      @default(0)
  criadoEm            DateTime @default(now())

  eventos        EventoOP[]
  produtosFinais ProdutoFinal[]
  subprodutos    Subproduto[]
  consumosPeca   ConsumoPeca[]
}

model EventoOP {
  id            String   @id
  opId          String
  etapa         String
  tipo          String
  funcionarioId String
  criadoEm      DateTime @default(now())

  ordemProducao OrdemProducao @relation(fields: [opId], references: [id])
}

model ProdutoFinal {
  id             String   @id
  opId           String
  serie          String   @unique
  codProdutoOmie String?
  criadoEm       DateTime @default(now())

  ordemProducao   OrdemProducao    @relation(fields: [opId], references: [id])
  subprodutos     Subproduto[]
  consumosPeca    ConsumoPeca[]
  expedicoesSerie ExpedicaoSerie[]
  manutencoes     Manutencao[]
  manutencoesSerie ManutencaoSerie[]
}

model Subproduto {
  id               String @id
  etiquetaId        String @unique
  codigoSubproduto  String
  opNumeroSubproduto String
  funcionarioId     String
  opId              String
  serieProdFinalId  String?

  ordemProducao     OrdemProducao @relation(fields: [opId], references: [id])
  produtoFinal      ProdutoFinal? @relation(fields: [serieProdFinalId], references: [id])
  consumosPeca      ConsumoPeca[]

  @@index([opId])
  @@index([codigoSubproduto])
  @@unique([serieProdFinalId, codigoSubproduto])
}


model ConsumoPeca {
  id            String @id
  codigoPeca    String
  qrCode        String
  qrId          String?
  funcionarioId String
  opId          String
  serieProdFinalId String?
  subprodutoId     String?

  inicioEm DateTime  @default(now())
  fimEm    DateTime?

  ordemProducao OrdemProducao @relation(fields: [opId], references: [id])
  produtoFinal  ProdutoFinal? @relation(fields: [serieProdFinalId], references: [id])
  subproduto    Subproduto?   @relation(fields: [subprodutoId], references: [id])

  @@unique([qrCode, fimEm])
  @@unique([qrId])
  @@index([codigoPeca])
  @@index([qrCode])
  @@index([serieProdFinalId])
  @@index([subprodutoId])
  @@index([opId])
}

/////////////////////////////////////////////////////////
////////////////// PROCESSO EXPEDIÃ‡ÃƒO ///////////////////
/////////////////////////////////////////////////////////

model Expedicao {
  id            String    @id
  numeroPedido  String
  chaveAtiva    String?   @unique
  empresa       String?
  status        String
  version       Int       @default(0)
  funcionarioId String
  iniciadoEm    DateTime  @default(now())
  finalizadoEm  DateTime?

  eventos     EventoExpedicao[]
  series      ExpedicaoSerie[]
  fotosGerais FotoExpedicaoGeral[]
}

model EventoExpedicao {
  id            String   @id
  expedicaoId   String
  tipo          String
  funcionarioId String
  criadoEm      DateTime @default(now())

  expedicao Expedicao @relation(fields: [expedicaoId], references: [id])
}

model ExpedicaoSerie {
  id           String @id
  expedicaoId  String
  codProdutoOmie String
  serie        String?
  serieProdFinalId String?

  expedicao    Expedicao     @relation(fields: [expedicaoId], references: [id])
  produtoFinal ProdutoFinal? @relation(fields: [serieProdFinalId], references: [id])
  fotos        FotoExpedicao[]

  @@index([expedicaoId])
  @@index([codProdutoOmie])
  @@index([serieProdFinalId])
}

model FotoExpedicao {
  id               String   @id
  expedicaoSerieId String
  url              String
  criadoEm         DateTime @default(now())

  expedicaoSerie ExpedicaoSerie @relation(fields: [expedicaoSerieId], references: [id])

  @@index([expedicaoSerieId])
}

model FotoExpedicaoGeral {
  id          String   @id
  expedicaoId String
  url         String
  descricao   String?
  criadoEm    DateTime @default(now())

  expedicao Expedicao @relation(fields: [expedicaoId], references: [id])

  @@index([expedicaoId])
}

/////////////////////////////////////////////////////////
////////////////// PROCESSO MANUTENCAO //////////////////
/////////////////////////////////////////////////////////

model Manutencao {
  id                      String    @id
  numeroOS                String?   @unique
  empresa                 String
  status                  String
  version                 Int       @default(0)
  funcionarioAberturaId   String
  funcionarioAtualId      String?
  codProdutoOmie          String?
  clienteNome             String?
  defeitoRelatado         String?
  diagnostico             String?
  emGarantia              Boolean?
  aprovadoOrcamento       Boolean?
  dataChegadaTransportadora DateTime?
  dataEntrada             DateTime  @default(now())
  dataAprovacao           DateTime?
  dataFinalizacao         DateTime?
  pesoKg                  Float?
  altura                  Float?
  largura                 Float?
  comprimento             Float?
  observacao              String?
  criadoEm                DateTime  @default(now())
  atualizadoEm            DateTime  @updatedAt
  serieProdFinalId        String?

  produtoFinal            ProdutoFinal?         @relation(fields: [serieProdFinalId], references: [id])
  eventos                 ManutencaoEvento[]
  series                  ManutencaoSerie[]
  pecasTrocadas           ManutencaoPecaTrocada[]

  @@index([status])
  @@index([dataEntrada])
}

model ManutencaoSerie {
  id              String   @id
  manutencaoId    String
  serie           String
  codProdutoOmie  String?
  serieProdFinalId String?
  criadoEm        DateTime @default(now())

  manutencao      Manutencao   @relation(fields: [manutencaoId], references: [id])
  produtoFinal    ProdutoFinal? @relation(fields: [serieProdFinalId], references: [id])
  pecasTrocadas   ManutencaoPecaTrocada[]

  @@unique([manutencaoId, serie])
  @@index([serie])
  @@index([manutencaoId, criadoEm])
  @@index([serieProdFinalId])
}

model ManutencaoEvento {
  id            String   @id
  manutencaoId  String
  tipo          String
  funcionarioId String
  setor         String?
  observacao    String?
  criadoEm      DateTime @default(now())

  manutencao Manutencao @relation(fields: [manutencaoId], references: [id])

  @@index([manutencaoId, criadoEm])
}

model ManutencaoPecaTrocada {
  id            String   @id
  manutencaoId  String
  manutencaoSerieId String?
  codigoPeca    String
  codigoSubproduto String?
  descricaoSubproduto String?
  qrCode        String?
  qrId          String?
  quantidade    Int      @default(1)
  funcionarioId String
  criadoEm      DateTime @default(now())
  fimEm         DateTime?

  manutencao Manutencao @relation(fields: [manutencaoId], references: [id])
  manutencaoSerie ManutencaoSerie? @relation(fields: [manutencaoSerieId], references: [id])

  @@index([manutencaoId, criadoEm])
  @@index([manutencaoSerieId])
  @@index([manutencaoId, codigoPeca, fimEm])
  @@index([codigoPeca])
  @@index([qrId])
}

model Funcionario {
  id          String   @id
  cracha      String   @unique
  nome        String
  setores     String
  ativo       Boolean  @default(true)
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
}


